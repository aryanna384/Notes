浏览器渲染引擎工作流程

## 页面渲染步骤

1. 解析HTML，构建DOM树
2. 解析CSS，生成CSS规则树(CSSOM)
3. 合并DOM树和CSS规则，生成render树
4. 布局render树**（Layout/reflow）**，负责各元素尺寸、位置的计算
5. 绘制render树（paint），绘制页面像素信息
6. 浏览器会将各层的信息发送给GPU，GPU会将各层合成（composite），显示在屏幕上

## 图层

创建图层条件：

    1. 拥有具有3D变换的CSS属性
    2. 使用加速视频解码的video节点
    3. canvas节点
    4. CSS3动画的节点
  5. 拥有CSS加速属性的元素(will-change)

## 重绘和回流

- Layout，也称为Reflow，即回流。一般意味着元素的**内容、结构、位置或尺寸**发生了变化，需要重新计算样式和渲染树
  - 页面首次渲染
  - 浏览器窗口大小发生改变
  - 元素尺寸或位置发生改变
  - 元素内容变化（文字数量或图片大小等等）
  - 元素字体大小变化
  - 添加或者删除**可见**的`DOM`元素
  - 激活`CSS`伪类（例如：`:hover`）
  - 查询某些属性或调用某些方法
- Repaint，即重绘。意味着元素发生的改变只是影响了元素的一些**外观**之类的时候（例如，背景色，边框颜色，文字颜色等），此时只需要应用新样式绘制这个元素就可以了

### 为什么会引起回流？

1.页面渲染初始化 

2.DOM结构改变，比如删除了某个节点

 3.render树变化，比如减少了padding 

4.窗口resize 5.最复杂的一种：获取某些属性，引发回流， 很多浏览器会对回流做优化，会等到数量足够时做一次批处理回流， 但是除了render树的直接变化，当获取一些属性时，浏览器为了获得正确的值也会触发回流，这样使得浏览器优化无效，包括

```
(1)offset(Top/Left/Width/Height)
(2) scroll(Top/Left/Width/Height)
(3) cilent(Top/Left/Width/Height)
(4) width,height
(5) 调用了getComputedStyle()或者IE的currentStyle
```

回流一定伴随着重绘，重绘却可以单独出现 回流优化，如：

- 减少逐项更改样式，最好一次性更改style，或者将样式定义为class并一次性更新
- 避免循环操作dom，创建一个documentFragment或div，在它上面应用所有DOM操作，最后再把它添加到window.document
- 避免多次读取offset等属性。无法避免则将它们缓存到变量
- 将复杂的元素绝对定位或固定定位，使得它脱离文档流，否则回流代价会很高